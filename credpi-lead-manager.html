<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credpi Lead Manager</title>
    <meta name="description" content="Lead management system for Credpi Advisory team">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5QEfFQkPtJeRPAAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAYSURBVFjD7cEBAQAAAIIg/69uSEAAAADAuQEBCAABsJJLjAAAAABJRU5ErkJggg==">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8f9fa; 
            color: #333;
            overflow-x: hidden;
        }
        .hidden { display: none !important; }
        
        /* Login Screen */
        .login-container { 
            min-height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .login-box { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
            width: 100%; 
            max-width: 380px; 
            text-align: center;
        }
        .logo { 
            font-size: 2.5rem; 
            margin-bottom: 10px; 
        }
        .login-title { 
            color: #333; 
            font-size: 24px; 
            margin-bottom: 8px; 
            font-weight: 700; 
        }
        .login-subtitle { 
            color: #666; 
            margin-bottom: 25px; 
            font-size: 14px;
        }
        
        /* Admin Login */
        .admin-login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .admin-login-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }
        
        /* Form Styles */
        .form-group { 
            margin-bottom: 16px; 
            text-align: left;
        }
        .form-label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 500; 
            color: #333; 
            font-size: 14px;
        }
        .form-input { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            background: #fff;
        }
        .form-input:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Buttons */
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            width: 100%;
            margin-bottom: 10px;
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-admin { 
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); 
            color: white; 
            width: 100%;
        }
        .btn-admin:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
            padding: 8px 16px;
            font-size: 14px;
        }
        .btn-secondary:hover { background: #5a6268; }
        .btn-add { 
            background: #28a745; 
            color: white; 
            padding: 10px 20px;
            white-space: nowrap;
        }
        .btn-add:hover { background: #218838; }
        .btn-call { 
            background: #17a2b8; 
            color: white; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            margin-right: 8px;
            text-decoration: none;
        }
        .btn-call:hover { background: #138496; color: white; }
        
        /* Messages */
        .message { 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 16px; 
            font-size: 14px;
        }
        .error-message { 
            background: #f8d7da; 
            color: #721c24; 
            border-left: 4px solid #dc3545; 
        }
        .success-message { 
            background: #d4edda; 
            color: #155724; 
            border-left: 4px solid #28a745; 
        }
        .demo-accounts { 
            background: #f8f9fa; 
            padding: 16px; 
            border-radius: 8px; 
            margin-top: 20px; 
            font-size: 13px;
            color: #6c757d;
        }
        
        /* Dashboard Layout */
        .dashboard { 
            background: #f8f9fa; 
            min-height: 100vh; 
        }
        .header { 
            background: white; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            max-width: 1200px;
            margin: 0 auto;
        }
        .logo-text { 
            font-size: 20px; 
            font-weight: 700; 
            color: #333; 
        }
        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        .user-avatar { 
            width: 36px; 
            height: 36px; 
            background: #667eea; 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600; 
        }
        
        /* Main Content */
        .main-content { 
            padding: 20px; 
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Stats Cards */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
            display: flex; 
            align-items: center; 
            transition: transform 0.2s ease;
        }
        .stat-card:hover { 
            transform: translateY(-2px); 
        }
        .stat-icon { 
            width: 48px; 
            height: 48px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            margin-right: 16px; 
        }
        .stat-info h3 { 
            font-size: 28px; 
            font-weight: 700; 
            color: #333; 
            margin-bottom: 4px; 
        }
        .stat-info p { 
            color: #666; 
            font-size: 14px; 
            font-weight: 500;
        }
        
        /* Controls */
        .controls { 
            background: white; 
            padding: 16px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
            margin-bottom: 20px; 
        }
        .controls-row { 
            display: flex; 
            gap: 12px; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .controls-left { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            flex: 1; 
        }
        .search-input, .filter-select { 
            padding: 8px 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 6px; 
            font-size: 14px;
        }
        .search-input { min-width: 200px; }
        .filter-select { min-width: 120px; }
        
        /* Table */
        .table-container { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
            overflow: hidden; 
        }
        .table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        .table th { 
            background: #f8f9fa; 
            padding: 16px 12px; 
            text-align: left; 
            font-weight: 600; 
            color: #495057; 
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .table td { 
            padding: 16px 12px; 
            border-bottom: 1px solid #e9ecef; 
            vertical-align: top;
        }
        .table tbody tr:hover { 
            background: #f8f9fa; 
        }
        .table tbody tr:last-child td { 
            border-bottom: none; 
        }
        
        /* Badges */
        .badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        .badge-callback { background: #fff2cc; color: #cc7a00; }
        .badge-close { background: #c8f7c5; color: #20c997; }
        .badge-docs { background: #e2d1ff; color: #6f42c1; }
        .badge-notinterested { background: #f8d7da; color: #dc3545; }
        .badge-alreadyapplied { background: #cce5ff; color: #0056b3; }
        
        .priority-low { background: #f8f9fa; color: #6c757d; }
        .priority-medium { background: #fff2cc; color: #cc7a00; }
        .priority-high { background: #f8d7da; color: #dc3545; }
        
        .role-admin { background: #f8d7da; color: #dc3545; }
        .role-manager { background: #d4edda; color: #28a745; }
        .role-caller { background: #cce5ff; color: #0056b3; }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
            width: 100%; 
            max-width: 600px; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .modal-header { 
            padding: 20px; 
            border-bottom: 1px solid #e9ecef; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .modal-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: #333; 
        }
        .modal-close { 
            background: none; 
            border: none; 
            font-size: 24px; 
            color: #666; 
            cursor: pointer; 
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { 
            background: #f8f9fa; 
        }
        .modal-body { 
            padding: 20px; 
        }
        .modal-footer { 
            padding: 20px; 
            border-top: 1px solid #e9ecef; 
            display: flex; 
            gap: 12px; 
            justify-content: flex-end; 
        }
        
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 16px; 
            margin-bottom: 16px; 
        }
        
        /* No Results */
        .no-leads { 
            text-align: center; 
            padding: 60px 20px; 
            color: #6c757d; 
        }
        .no-leads-icon { 
            font-size: 48px; 
            margin-bottom: 16px; 
            opacity: 0.5; 
        }
        
        /* Link Styles */
        .register-link { 
            text-align: center; 
            margin-top: 16px; 
            color: #667eea; 
            cursor: pointer; 
            text-decoration: underline; 
            font-size: 14px;
        }
        .register-link:hover { 
            color: #5a6bd8; 
        }
        
        /* Action Buttons */
        .action-btn { 
            background: none; 
            border: none; 
            color: #6c757d; 
            cursor: pointer; 
            margin-right: 8px; 
            font-size: 16px; 
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .action-btn:hover { 
            background: #f8f9fa; 
            color: #495057;
        }
        .action-btn.danger { 
            color: #dc3545; 
        }
        .action-btn.danger:hover { 
            background: #f8d7da; 
            color: #721c24;
        }

        /* Admin Panel Styles */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .admin-stat-card {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        .users-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        .users-list-header {
            background: #f8f9fa;
            padding: 16px;
            font-weight: 600;
            border-bottom: 1px solid #e9ecef;
        }
        .user-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        
        /* Custom Input Styles */
        .custom-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .custom-input {
            flex: 1;
            min-width: 150px;
        }
        .add-custom-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .custom-options {
            margin-top: 8px;
        }
        .custom-option {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        .custom-option:hover {
            background: #dc3545;
            color: white;
        }
        
        /* Responsive Design - Mobile App View */
        @media (max-width: 768px) {
            .header-content { 
                padding: 8px 0;
                gap: 8px;
            }
            .logo-text {
                font-size: 16px;
            }
            .user-info {
                gap: 8px;
            }
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .controls-row { 
                flex-direction: column; 
                align-items: stretch;
                gap: 8px;
            }
            .controls-left { 
                flex-direction: column;
                gap: 8px;
            }
            .search-input, .filter-select {
                min-width: auto;
                width: 100%;
            }
            
            .table-container { 
                overflow-x: auto;
                border-radius: 8px;
            }
            .table th, .table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .modal-content { 
                margin: 10px; 
                max-width: calc(100vw - 20px);
                border-radius: 8px;
            }
            .modal-header, .modal-body, .modal-footer {
                padding: 16px;
            }
            
            .form-grid { 
                grid-template-columns: 1fr; 
                gap: 12px;
            }
            .stats-grid { 
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            .stat-card {
                padding: 16px;
                border-radius: 8px;
            }
            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
                margin-right: 12px;
            }
            .stat-info h3 {
                font-size: 22px;
            }
            .stat-info p {
                font-size: 12px;
            }
            
            .main-content { 
                padding: 12px; 
            }
            
            /* Mobile-friendly buttons */
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            .btn-call {
                padding: 8px 12px;
                font-size: 11px;
                border-radius: 16px;
            }
            .action-btn {
                padding: 6px;
                margin-right: 6px;
            }
            
            /* Better mobile table */
            .customer-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            .customer-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
                margin-right: 8px;
            }
            .customer-name {
                font-size: 13px;
                margin-bottom: 2px;
            }
            .customer-contact {
                font-size: 11px;
            }
            
            .loan-info .loan-type {
                font-size: 12px;
            }
            .loan-amount {
                font-size: 12px;
            }
            .loan-details {
                font-size: 11px;
            }
            
            /* Mobile admin panel */
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            .admin-stat-card {
                padding: 12px;
                text-align: center;
            }
            .admin-stat-card h4 {
                font-size: 13px;
                margin-bottom: 6px;
            }
            .admin-stat-card h3 {
                font-size: 20px;
            }
            .admin-stat-card p {
                font-size: 11px;
            }
            
            .user-item {
                padding: 10px 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .user-item > div:last-child {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 6px;
            }
            
            /* Login screen mobile */
            .login-box {
                padding: 20px;
                margin: 10px;
                max-width: calc(100vw - 20px);
            }
            .login-title {
                font-size: 20px;
            }
            .logo {
                font-size: 2rem;
            }
            
            /* Form inputs mobile */
            .form-input {
                padding: 10px 14px;
                font-size: 14px;
            }
            .form-label {
                font-size: 13px;
            }
            
            /* Hide less important columns on very small screens */
            @media (max-width: 480px) {
                .table th:nth-child(4),
                .table td:nth-child(4) {
                    display: none; /* Hide priority column */
                }
                .stats-grid {
                    grid-template-columns: 1fr;
                }
                .customer-info {
                    flex-direction: row;
                    align-items: center;
                }
            }
        }

        /* Customer Info Styles */
        .customer-info { 
            display: flex; 
            align-items: center; 
        }
        .customer-avatar { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 12px; 
            font-size: 18px;
            color: white;
        }
        .customer-details { 
            flex: 1; 
        }
        .customer-name { 
            font-weight: 600; 
            color: #333; 
            margin-bottom: 4px; 
        }
        .customer-contact { 
            color: #6c757d; 
            font-size: 13px; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            margin-bottom: 2px;
        }

        /* Loan Details */
        .loan-info { 
            flex: 1; 
        }
        .loan-type { 
            font-weight: 600; 
            color: #333; 
            margin-bottom: 4px; 
        }
        .loan-amount { 
            color: #28a745; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            margin-bottom: 2px;
        }
        .loan-details { 
            color: #6c757d; 
            font-size: 13px; 
        }

        /* Added By Info */
        .added-by { 
            flex: 1; 
        }
        .added-name { 
            font-weight: 600; 
            color: #333; 
            margin-bottom: 4px; 
        }
        .added-date { 
            color: #6c757d; 
            font-size: 13px; 
        }

        /* Actions */
        .actions { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
        }

        /* Install Prompt */
        .install-banner {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        .install-banner:hover {
            background: linear-gradient(135deg, #218838 0%, #1ba085 100%);
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .auto-save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">Data Saved</div>

    <!-- PWA Install Banner -->
    <div id="installBanner" class="install-banner hidden">
        Install Credpi App - Tap here to add to your home screen!
    </div>

    <!-- ADMIN LOGIN MODAL -->
    <div id="adminLoginModal" class="admin-login-container">
        <div class="admin-login-box">
            <h2 style="margin-bottom: 20px; text-align: center; color: #dc3545;">Admin Access</h2>
            <div class="form-group">
                <label class="form-label">Admin Username</label>
                <input type="text" id="adminUsername" class="form-input" placeholder="Enter admin username">
            </div>
            <div class="form-group">
                <label class="form-label">Admin Password</label>
                <input type="password" id="adminPassword" class="form-input" placeholder="Enter admin password">
            </div>
            <div id="adminLoginError" class="message error-message hidden"></div>
            <button onclick="handleAdminLogin()" class="btn btn-admin" style="width: 100%; margin-bottom: 10px;">Access Admin Panel</button>
            <button onclick="closeAdminLogin()" class="btn btn-secondary" style="width: 100%;">Cancel</button>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="logo">üè¢</div>
            <h1 class="login-title">Credpi Advisory</h1>
            <p class="login-subtitle">Lead Management System</p>
            
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" id="loginName" class="form-input" placeholder="Enter your full name" autocomplete="name">
                </div>
                <div class="form-group">
                    <label class="form-label">Mobile Number</label>
                    <input type="tel" id="loginMobile" class="form-input" placeholder="+91 98765 43210" autocomplete="tel">
                </div>
                
                <div id="loginError" class="message error-message hidden"></div>
                <div id="loginSuccess" class="message success-message hidden"></div>
                
                <button onclick="handleLogin()" class="btn btn-primary">Login to Dashboard</button>
                
                <div class="register-link" onclick="showRegisterForm()">
                    New user? Register here
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" id="regName" class="form-input" placeholder="Enter your full name" autocomplete="name">
                </div>
                <div class="form-group">
                    <label class="form-label">Mobile Number *</label>
                    <input type="tel" id="regMobile" class="form-input" placeholder="+91 98765 43210" autocomplete="tel">
                </div>
                <div class="form-group">
                    <label class="form-label">Employee ID (Optional)</label>
                    <input type="text" id="regEmployeeId" class="form-input" placeholder="EMP001">
                </div>
                
                <button onclick="handleRegister()" class="btn btn-primary">Register</button>
                <div class="register-link" onclick="showLoginForm()">
                    Already registered? Login here
                </div>
            </div>
            
            <div class="demo-accounts">
                <p><strong>Demo Account:</strong></p>
                <p>Name: John Doe</p>
                <p>Mobile: +91 98765 43210</p>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard" class="dashboard hidden">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <span class="logo-text">üè¢ Credpi Advisory</span>
                    <span id="userRole" class="badge" style="margin-left: 8px;"></span>
                </div>
                <div class="user-info">
                    <button id="adminBtn" onclick="showAdminLogin()" class="btn btn-secondary hidden">Admin</button>
                    <button id="teamBtn" onclick="toggleTeam()" class="btn btn-secondary hidden">Team</button>
                    <span id="currentUserName">User</span>
                    <div id="userAvatar" class="user-avatar">U</div>
                    <button onclick="handleLogout()" class="action-btn">Logout</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Admin Panel (Hidden by default) -->
            <div id="adminSection" class="hidden">
                <div class="table-container" style="margin-bottom: 20px;">
                    <div style="padding: 20px; border-bottom: 1px solid #e9ecef;">
                        <h2 style="margin: 0; color: #dc3545; font-size: 18px;">Admin Panel</h2>
                    </div>
                    <div style="padding: 20px;">
                        <div class="admin-stats">
                            <div class="admin-stat-card">
                                <h4 style="margin-bottom: 8px; color: #333;">Total Users</h4>
                                <h3 id="totalUsers" style="color: #667eea;">0</h3>
                                <p style="font-size: 12px; color: #6c757d;">/ 100 Max</p>
                            </div>
                            <div class="admin-stat-card">
                                <h4 style="margin-bottom: 8px; color: #333;">Managers</h4>
                                <h3 id="totalManagers" style="color: #28a745;">0</h3>
                            </div>
                            <div class="admin-stat-card">
                                <h4 style="margin-bottom: 8px; color: #333;">Telecallers</h4>
                                <h3 id="totalCallers" style="color: #17a2b8;">0</h3>
                            </div>
                            <div class="admin-stat-card">
                                <h4 style="margin-bottom: 8px; color: #333;">Total Leads</h4>
                                <h3 id="adminTotalLeads" style="color: #fd7e14;">0</h3>
                            </div>
                        </div>
                        
                        <!-- All Users List -->
                        <div class="users-list">
                            <div class="users-list-header">
                                All Registered Users
                            </div>
                            <div id="allUsersList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Performance (Hidden by default) -->
            <div id="teamSection" class="hidden">
                <div class="table-container" style="margin-bottom: 20px;">
                    <div style="padding: 20px; border-bottom: 1px solid #e9ecef;">
                        <h2 id="teamSectionTitle" style="margin: 0; color: #333; font-size: 18px;">Team Performance</h2>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Team Member</th>
                                    <th>Mobile</th>
                                    <th>Role</th>
                                    <th>Leads</th>
                                    <th>Approved</th>
                                    <th>Rate</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teamTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e3f2fd;">üë•</div>
                    <div class="stat-info">
                        <h3 id="totalLeads">0</h3>
                        <p id="totalLeadsLabel">Total Leads</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fff3e0;">üéØ</div>
                    <div class="stat-info">
                        <h3 id="newLeads">0</h3>
                        <p>Call back</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e8f5e8;">üìû</div>
                    <div class="stat-info">
                        <h3 id="contactedLeads">0</h3>
                        <p>Docs pending</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e0f2f1;">üìà</div>
                    <div class="stat-info">
                        <h3 id="conversionRate">0%</h3>
                        <p>Success Rate</p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="controls-row">
                    <div class="controls-left">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search leads..." oninput="filterLeads()">
                        <select id="statusFilter" class="filter-select" onchange="filterLeads()">
                            <option value="All">All Status</option>
                            <option value="Call back">Call back</option>
                            <option value="Close">Close</option>
                            <option value="Docs pending">Docs pending</option>
                            <option value="Not interested">Not interested</option>
                            <option value="Already applied">Already applied</option>
                        </select>
                        <select id="priorityFilter" class="filter-select" onchange="filterLeads()">
                            <option value="All">All Priority</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                        <select id="userFilter" class="filter-select hidden" onchange="filterLeads()">
                            <option value="All">All Team</option>
                        </select>
                    </div>
                    <button onclick="showAddModal()" class="btn btn-add">Add Lead</button>
                    <button id="exportCsvBtn" onclick="exportToCSV()" class="btn btn-secondary hidden" style="background: #28a745; color: white;">üì• Export CSV</button>
                </div>
            </div>

            <!-- Leads Table -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Customer</th>
                            <th style="width: 20%;">Loan Details</th>
                            <th style="width: 12%;">Status</th>
                            <th style="width: 8%;">Priority</th>
                            <th style="width: 15%;">Added By</th>
                            <th style="width: 10%;">Timestamp</th>
                            <th style="width: 15%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTable"></tbody>
                </table>
                <div id="noLeads" class="no-leads hidden">
                    <div class="no-leads-icon">üìã</div>
                    <h3>No leads found</h3>
                    <p>Get started by adding your first lead.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD LEAD MODAL -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Lead</h3>
                <button onclick="hideAddModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Customer Name *</label>
                        <input type="text" id="customerName" class="form-input" placeholder="Enter customer name" autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Number *</label>
                        <input type="tel" id="customerPhone" class="form-input" placeholder="+91 98765 43210" autocomplete="tel">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Net Salary (Monthly) *</label>
                        <input type="number" id="netSalary" class="form-input" placeholder="50000" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Name *</label>
                        <input type="text" id="companyName" class="form-input" placeholder="Company Name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Obligation (Loan Amount) *</label>
                        <input type="number" id="loanAmount" class="form-input" placeholder="500000" min="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bank Name</label>
                        <select id="bankName" class="form-input" onchange="handleBankSelection()">
                            <option value="">Select Bank</option>
                        </select>
                        <div id="customBankInput" class="hidden" style="margin-top: 8px;">
                            <input type="text" id="customBankName" class="form-input" placeholder="Enter bank name" style="font-size: 14px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Loan Type</label>
                        <select id="loanType" class="form-input">
                            <option value="">Select Loan Type</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="leadPriority" class="form-input">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="leadNotes" class="form-input" rows="3" placeholder="Additional information about the lead..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="hideAddModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="addLead()" class="btn btn-primary">Add Lead</button>
            </div>
        </div>
    </div>

    <!-- VIEW LEAD MODAL -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Lead Details</h3>
                <button onclick="hideViewModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="leadDetails"></div>
            <div class="modal-footer">
                <button onclick="hideViewModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- ASSIGN LEAD MODAL -->
    <div id="assignLeadModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Assign Lead</h3>
                <button onclick="hideAssignLeadModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px;">Assigning lead to a team member:</p>
                <div class="form-group">
                    <label class="form-label">Search Team Member</label>
                    <input type="text" id="assignCallerSearch" class="form-input" placeholder="Search by name or mobile" oninput="filterAssignCallers()">
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">Select Team Member</label>
                    <select id="assignToUser" class="form-input"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="hideAssignLeadModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="performLeadAssignment()" class="btn btn-primary">Assign Lead</button>
            </div>
        </div>
    </div>

    <!-- TRANSFER LEADS MODAL -->
    <div id="transferModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Leads</h3>
                <button onclick="hideTransferLeadsModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Transferring Leads from:</strong> <span id="sourceUserPlaceholder"></span></p>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">Transfer to Team Member</label>
                    <select id="transferToUser" class="form-input"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="hideTransferLeadsModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="performLeadTransfer()" class="btn btn-primary">Transfer</button>
            </div>
        </div>
    </div>

    <!-- ASSIGN MANAGER MODAL -->
    <div id="assignManagerModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Assign Team Leader</h3>
                <button onclick="hideAssignManagerModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Assigning Team Leader to:</strong> <span id="callerNamePlaceholder"></span></p>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">Select Team Leader</label>
                    <select id="selectManager" class="form-input"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="hideAssignManagerModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="performAssignManager()" class="btn btn-primary">Assign</button>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL DATA
        let currentUser = null;
        let showTeamSection = false;
        let showAdminSection = false;
        let deferredPrompt = null;
        let sourceUserIdForTransfer = null;
        let callerIdForManagerAssignment = null;
        let leadIdForAssignment = null;

        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'credpiadmin',
            password: 'admin@2025'
        };

        // Custom options data - EXPLICITLY DEFINED
        const customBanks = [
            'HDFC Bank', 'IDFC Bank', 'Axis Bank', 'ICICI Bank', 'IndusInd Bank', 'Kotak Bank', 'Other Bank'
        ];
        const customLoanTypes = [
            'Personal Loan', 'Business Loan', 'Home Loan', 'Education Loan'
        ];

        // System users with team assignments
        let users = [
            { 
                id: 1, 
                name: 'Admin', 
                mobile: '+919999900000', 
                role: 'admin', 
                employeeId: 'ADMIN001',
                joinDate: '2024-01-01',
                managerId: null
            },
            { 
                id: 2, 
                name: 'John Doe', 
                mobile: '+919876543210', 
                role: 'caller', 
                employeeId: 'EMP001',
                joinDate: '2024-01-15',
                managerId: 3
            },
            { 
                id: 3, 
                name: 'Priya Sharma', 
                mobile: '+918765432109', 
                role: 'manager', 
                employeeId: 'MGR001',
                joinDate: '2024-01-10',
                managerId: null
            },
            { 
                id: 4, 
                name: 'Anita Singh', 
                mobile: '+917654321098', 
                role: 'caller', 
                employeeId: 'EMP002',
                joinDate: '2024-02-01',
                managerId: 3
            }
        ];

        // Sample leads
        let leads = [
            {
                id: 1,
                customerName: 'Rajesh Kumar',
                phone: '+919876543210',
                netSalary: 80000,
                companyName: 'Tech Solutions Pvt Ltd',
                loanAmount: 500000,
                bankName: 'HDFC Bank',
                loanType: 'Personal Loan',
                status: 'Call back',
                priority: 'High',
                addedBy: 'John Doe',
                addedByMobile: '+919876543210',
                teamLeader: 'Priya Sharma',
                timestamp: '2025-08-29 10:30:00',
                notes: 'Interested in personal loan for home renovation'
            },
            {
                id: 2,
                customerName: 'Priya Patel',
                phone: '+918765432109',
                netSalary: 150000,
                companyName: 'Textile Industries Ltd',
                loanAmount: 2000000,
                bankName: 'SBI',
                loanType: 'Business Loan',
                status: 'Docs pending',
                priority: 'Medium',
                addedBy: 'Anita Singh',
                addedByMobile: '+917654321098',
                teamLeader: 'Priya Sharma',
                timestamp: '2025-08-29 09:15:00',
                notes: 'Looking to expand textile business'
            }
        ];

        // Load data from localStorage on page load
        function loadData() {
            const savedUsers = localStorage.getItem('credpi_users');
            const savedLeads = localStorage.getItem('credpi_leads');
            
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            if (savedLeads) {
                leads = JSON.parse(savedLeads);
            }
            
            // Check for saved user session
            const savedUser = localStorage.getItem('credpi_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('credpi_users', JSON.stringify(users));
            localStorage.setItem('credpi_leads', JSON.stringify(leads));
            
            if (currentUser) {
                localStorage.setItem('credpi_current_user', JSON.stringify(currentUser));
            }
            
            showAutoSaveIndicator();
        }

        // Show auto-save indicator
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // PWA FUNCTIONALITY
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.remove('hidden');
        });

        document.getElementById('installBanner').addEventListener('click', () => {
            if (deferredPrompt) {
                document.getElementById('installBanner').classList.add('hidden');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    deferredPrompt = null;
                });
            }
        });

        // UTILITY FUNCTIONS
        function generateId() {
            return Date.now() + Math.floor(Math.random() * 1000);
        }

        function formatDate(date) {
            return new Date(date).toISOString().split('T')[0];
        }

        function formatDateTime(date) {
            const d = new Date(date);
            return d.toISOString().slice(0, 19).replace('T', ' ');
        }

        function formatMobile(mobile) {
            return mobile.replace(/\s+/g, '').replace(/[^\d+]/g, '');
        }

        function getManagerName(managerId) {
            if (!managerId) return 'Unassigned';
            const manager = users.find(u => u.id === managerId);
            return manager ? manager.name : 'Unassigned';
        }

        function getTeamMembers(managerId) {
            return users.filter(u => u.managerId === managerId && u.role === 'caller');
        }

        // ADMIN LOGIN FUNCTIONS
        function showAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'flex';
            document.getElementById('adminUsername').focus();
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginError').classList.add('hidden');
        }

        function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                closeAdminLogin();
                showAdminSection = true;
                document.getElementById('adminSection').classList.remove('hidden');
                renderAdminPanel();
            } else {
                document.getElementById('adminLoginError').textContent = 'Invalid admin credentials';
                document.getElementById('adminLoginError').classList.remove('hidden');
            }
        }

        // ADMIN PANEL FUNCTIONS
        function promoteToManager(userId) {
            const totalManagers = users.filter(u => u.role === 'manager').length;
            if (totalManagers >= 10) {
                alert('Cannot promote: Maximum 10 managers allowed');
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1 && users[userIndex].role === 'caller') {
                users[userIndex].role = 'manager';
                users[userIndex].managerId = null; // Managers don't have managers
                saveData();
                renderAdminPanel();
                alert(`${users[userIndex].name} promoted to Manager`);
            }
        }

        function demoteToCaller(userId) {
            const totalCallers = users.filter(u => u.role === 'caller').length;
            if (totalCallers >= 100) {
                alert('Cannot demote: Maximum 100 callers allowed');
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1 && users[userIndex].role === 'manager') {
                // First, unassign all callers from this manager
                users.forEach(u => {
                    if (u.managerId === userId) {
                        u.managerId = null;
                    }
                });
                
                users[userIndex].role = 'caller';
                users[userIndex].managerId = null;
                saveData();
                renderAdminPanel();
                updateStats();
                renderLeads();
                alert(`${users[userIndex].name} demoted to Caller. All team members unassigned.`);
            }
        }

        function showAssignManagerModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user || user.role !== 'caller') return;
            
            callerIdForManagerAssignment = userId;
            document.getElementById('callerNamePlaceholder').textContent = user.name;
            
            const managerSelect = document.getElementById('selectManager');
            managerSelect.innerHTML = '<option value="">Unassigned</option>';
            
            const managers = users.filter(u => u.role === 'manager');
            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager.id;
                option.textContent = manager.name;
                if (user.managerId === manager.id) {
                    option.selected = true;
                }
                managerSelect.appendChild(option);
            });

            document.getElementById('assignManagerModal').classList.add('show');
        }

        function hideAssignManagerModal() {
            document.getElementById('assignManagerModal').classList.remove('show');
            callerIdForManagerAssignment = null;
        }

        function performAssignManager() {
            const caller = users.find(u => u.id === callerIdForManagerAssignment);
            const selectedManagerId = document.getElementById('selectManager').value;
            
            if (!caller) {
                alert('Error: Caller not found.');
                return;
            }

            if (selectedManagerId === "") {
                caller.managerId = null;
                alert(`${caller.name} is now unassigned from any manager.`);
            } else {
                const selectedManager = users.find(u => u.id == selectedManagerId);
                if (selectedManager) {
                    caller.managerId = selectedManager.id;
                    alert(`${caller.name} has been assigned to manager: ${selectedManager.name}`);
                }
            }
            
            saveData();
            renderAdminPanel();
            hideAssignManagerModal();
        }

        function removeUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user || user.role === 'admin') return;
            
            if (confirm(`Are you sure you want to remove ${user.name}?\n\nThis will also delete all their leads.`)) {
                if (user.role === 'manager') {
                    // Unassign all callers from this manager
                    users.forEach(u => {
                        if (u.managerId === userId) {
                            u.managerId = null;
                        }
                    });
                }
                
                // Remove user's leads
                leads = leads.filter(l => l.addedByMobile !== user.mobile);
                
                // Remove user
                users = users.filter(u => u.id !== userId);
                
                saveData();
                renderAdminPanel();
                updateStats();
                renderLeads();
                alert(`${user.name} removed from system`);
            }
        }

        // LOGIN/REGISTER FUNCTIONS
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const mobile = formatMobile(document.getElementById('regMobile').value.trim());
            const employeeId = document.getElementById('regEmployeeId').value.trim() || 'EMP' + (users.length + 1).toString().padStart(3, '0');
            
            if (!name || !mobile) {
                showError('Please enter both name and mobile number');
                return;
            }

            const totalCallers = users.filter(u => u.role === 'caller').length;
            if (totalCallers >= 100) {
                showError('System is full. Maximum 100 callers allowed.');
                return;
            }

            const existingUser = users.find(u => u.mobile === mobile);
            if (existingUser) {
                showError('Mobile number already registered. Please login instead.');
                return;
            }

            const newUser = {
                id: generateId(),
                name: name,
                mobile: mobile,
                role: 'caller',
                employeeId: employeeId,
                joinDate: formatDate(new Date()),
                managerId: null
            };

            users.push(newUser);
            saveData();
            showSuccess('Registration successful! You can now login.');
            showLoginForm();
        }

        function handleLogin() {
            const name = document.getElementById('loginName').value.trim();
            const mobile = formatMobile(document.getElementById('loginMobile').value.trim());
            
            if (!name || !mobile) {
                showError('Please enter both name and mobile number');
                return;
            }

            const user = users.find(u => u.name.toLowerCase() === name.toLowerCase() && u.mobile === mobile);
            if (user) {
                currentUser = user;
                saveData();
                showDashboard();
            } else {
                showError('Invalid credentials. Please check your name and mobile number or register first.');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('loginSuccess').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('loginSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('loginError').classList.add('hidden');
        }

        function handleLogout() {
            currentUser = null;
            showTeamSection = false;
            showAdminSection = false;
            localStorage.removeItem('credpi_current_user');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginName').value = '';
            document.getElementById('loginMobile').value = '';
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginSuccess').classList.add('hidden');
            showLoginForm();
        }

        // CUSTOM OPTIONS FUNCTIONS
        function populateCustomOptions() {
            // Populate bank options
            const bankSelect = document.getElementById('bankName');
            bankSelect.innerHTML = '<option value="">Select Bank</option>';
            customBanks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                bankSelect.appendChild(option);
            });

            // Populate loan type options
            const loanTypeSelect = document.getElementById('loanType');
            loanTypeSelect.innerHTML = '<option value="">Select Loan Type</option>';
            customLoanTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                loanTypeSelect.appendChild(option);
            });
        }

        function handleBankSelection() {
            const bankSelect = document.getElementById('bankName');
            const customBankInput = document.getElementById('customBankInput');
            const customBankName = document.getElementById('customBankName');
            
            if (bankSelect.value === 'Other Bank') {
                customBankInput.classList.remove('hidden');
                customBankName.focus();
            } else {
                customBankInput.classList.add('hidden');
                customBankName.value = '';
            }
        }

        // DASHBOARD FUNCTIONS
        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            const roleElement = document.getElementById('userRole');
            roleElement.textContent = currentUser.role.toUpperCase();
            roleElement.className = `badge role-${currentUser.role}`;
            
            // Only admin can see admin and team buttons and export button
            document.getElementById('adminBtn').classList.toggle('hidden', currentUser.role !== 'admin');
            document.getElementById('teamBtn').classList.toggle('hidden', currentUser.role !== 'admin' && currentUser.role !== 'manager');
            document.getElementById('userFilter').classList.toggle('hidden', currentUser.role !== 'admin' && currentUser.role !== 'manager');
            document.getElementById('exportCsvBtn').classList.toggle('hidden', currentUser.role !== 'admin');
            
            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                populateUserFilter();
            }
            
            populateCustomOptions();
            updateStats();
            renderLeads();
        }

        function populateUserFilter() {
            const userFilter = document.getElementById('userFilter');
            userFilter.innerHTML = '<option value="All">All Team</option>';
            
            let usersToShow = [];
            
            if (currentUser.role === 'admin') {
                // Only admin can filter by all users
                usersToShow = users.filter(u => u.role === 'caller' || u.role === 'manager');
            } else if (currentUser.role === 'manager') {
                // Managers can only filter by their team members
                usersToShow = getTeamMembers(currentUser.id);
            }
            
            usersToShow.forEach(user => {
                const option = document.createElement('option');
                option.value = user.mobile;
                option.textContent = `${user.name} (${user.role})`;
                userFilter.appendChild(option);
            });
        }

        function toggleTeam() {
            showTeamSection = !showTeamSection;
            const teamSection = document.getElementById('teamSection');
            
            if (showTeamSection) {
                teamSection.classList.remove('hidden');
                renderTeamPerformance();
            } else {
                teamSection.classList.add('hidden');
            }
        }

        function renderAdminPanel() {
            const totalCallers = users.filter(u => u.role === 'caller').length;
            const totalManagers = users.filter(u => u.role === 'manager').length;
            
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalManagers').textContent = `${totalManagers} / 10`;
            document.getElementById('totalCallers').textContent = `${totalCallers} / 100`;
            document.getElementById('adminTotalLeads').textContent = leads.length;

            const container = document.getElementById('allUsersList');
            container.innerHTML = '';
            
            users.filter(u => u.role !== 'admin').forEach(user => {
                const userLeads = leads.filter(l => l.addedByMobile === user.mobile);
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                
                userDiv.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: #333;">${user.name}</div>
                        <div style="color: #6c757d; font-size: 13px;">${user.mobile}</div>
                        <div style="color: #28a745; font-size: 12px;">ID: ${user.employeeId} | Leads: ${userLeads.length} | Joined: ${user.joinDate}</div>
                        ${user.role === 'caller' && user.managerId ? `<div style="color: #666; font-size: 11px;">Manager: ${getManagerName(user.managerId)}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <span class="badge role-${user.role}">${user.role.toUpperCase()}</span>
                        ${user.role === 'caller' ? `
                            <button onclick="promoteToManager(${user.id})" 
                                    style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;"
                                    ${totalManagers >= 10 ? 'disabled title="Manager limit reached (10/10)"' : ''}>
                                ${totalManagers >= 10 ? 'Manager Full' : 'Promote to Manager'}
                            </button>
                        ` : ''}
                        ${user.role === 'manager' ? `
                            <button onclick="demoteToCaller(${user.id})" 
                                    style="background: #fd7e14; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;"
                                    ${totalCallers >= 100 ? 'disabled title="Caller limit reached (100/100)"' : ''}>
                                ${totalCallers >= 100 ? 'Caller Full' : 'Demote to Caller'}
                            </button>
                        ` : ''}
                        <button onclick="showAssignManagerModal(${user.id})" 
                                style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;"
                                ${user.role !== 'caller' ? 'style="display: none;"' : ''}>
                            Assign Team Leader
                        </button>
                        <button onclick="removeUser(${user.id})" 
                                style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Remove
                        </button>
                    </div>
                `;
                
                container.appendChild(userDiv);
            });
        }

        function renderTeamPerformance() {
            const tbody = document.getElementById('teamTableBody');
            tbody.innerHTML = '';
            
            let teamMembers = [];
            let titleText = 'Team Performance';
            
            if (currentUser.role === 'admin') {
                // Admin views all users
                teamMembers = users.filter(u => u.role !== 'admin');
                titleText = 'All Team Performance';
            } else if (currentUser.role === 'manager') {
                // Managers view their team members
                teamMembers = getTeamMembers(currentUser.id);
                titleText = 'My Team Performance';
            }
            
            document.getElementById('teamSectionTitle').textContent = titleText;
            
            const performance = teamMembers.map(user => {
                const userLeads = leads.filter(l => l.addedByMobile === user.mobile);
                const approved = userLeads.filter(l => l.status === 'Close').length;
                const conversionRate = userLeads.length > 0 ? ((approved / userLeads.length) * 100).toFixed(1) : 0;
                
                return {
                    ...user,
                    totalLeads: userLeads.length,
                    approvedLeads: approved,
                    conversionRate: parseFloat(conversionRate)
                };
            });
            
            performance.sort((a, b) => b.totalLeads - a.totalLeads);
            
            performance.forEach(member => {
                const row = tbody.insertRow();
                const badgeClass = member.conversionRate >= 20 ? 'badge-approved' : 
                                     member.conversionRate >= 10 ? 'badge-contacted' : 'badge-rejected';
                
                row.innerHTML = `
                    <td>
                        <div class="customer-info">
                            <div class="customer-avatar">${member.name.charAt(0)}</div>
                            <div>
                                <div class="customer-name">${member.name}</div>
                                ${member.role === 'caller' && member.managerId ? 
                                    `<div style="font-size: 11px; color: #6c757d;">Manager: ${getManagerName(member.managerId)}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td style="font-size: 13px; color: #6c757d;">${member.mobile}</td>
                    <td><span class="badge role-${member.role}">${member.role}</span></td>
                    <td style="font-weight: 600; color: #333;">${member.totalLeads}</td>
                    <td style="font-weight: 600; color: #28a745;">${member.approvedLeads}</td>
                    <td><span class="badge ${badgeClass}">${member.conversionRate}%</span></td>
                    <td>
                        <button onclick="showTransferLeadsModal(${member.id})"
                                style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;"
                                ${member.role !== 'caller' || currentUser.role !== 'manager' ? 'style="display: none;"' : ''}>
                            Transfer Leads
                        </button>
                    </td>
                `;
            });
        }

        function updateStats() {
            let userLeads = [];
            
            if (currentUser.role === 'admin') {
                userLeads = leads;
            } else if (currentUser.role === 'manager') {
                // Managers can only view their team's leads statistics
                const teamMembers = getTeamMembers(currentUser.id);
                const teamMobiles = teamMembers.map(m => m.mobile);
                teamMobiles.push(currentUser.mobile); // Include manager's own leads
                userLeads = leads.filter(l => teamMobiles.includes(l.addedByMobile));
            } else {
                // Callers can only view their own leads statistics
                userLeads = leads.filter(l => l.addedByMobile === currentUser.mobile);
            }
            
            const totalLeads = userLeads.length;
            const newLeads = userLeads.filter(l => l.status === 'Call back').length;
            const contactedLeads = userLeads.filter(l => l.status === 'Docs pending').length;
            const approvedLeads = userLeads.filter(l => l.status === 'Close').length;
            const conversionRate = totalLeads > 0 ? ((approvedLeads / totalLeads) * 100).toFixed(1) : 0;
            
            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('totalLeadsLabel').textContent = 
                currentUser.role === 'admin' ? 'All Leads' : 
                currentUser.role === 'manager' ? 'Team Leads' : 'My Leads';
            document.getElementById('newLeads').textContent = newLeads;
            document.getElementById('contactedLeads').textContent = contactedLeads;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
        }

        function getFilteredLeads() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const userFilter = document.getElementById('userFilter').value;
            
            let filtered = [];
            
            if (currentUser.role === 'admin') {
                // Admin can view all leads
                filtered = leads;
            } else if (currentUser.role === 'manager') {
                // Managers can only view their team's leads
                const teamMembers = getTeamMembers(currentUser.id);
                const teamMobiles = teamMembers.map(m => m.mobile);
                teamMobiles.push(currentUser.mobile); // Include manager's own leads
                filtered = leads.filter(lead => teamMobiles.includes(lead.addedByMobile));
            } else {
                // Callers can only view their own leads
                filtered = leads.filter(lead => lead.addedByMobile === currentUser.mobile);
            }
            
            if (userFilter !== 'All') {
                filtered = filtered.filter(lead => lead.addedByMobile === userFilter);
            }
            
            filtered = filtered.filter(lead => {
                const matchesSearch = lead.customerName.toLowerCase().includes(searchTerm) ||
                                     lead.phone.includes(searchTerm) ||
                                     (lead.companyName && lead.companyName.toLowerCase().includes(searchTerm));
                const matchesStatus = statusFilter === 'All' || lead.status === statusFilter;
                const matchesPriority = priorityFilter === 'All' || lead.priority === priorityFilter;
                
                return matchesSearch && matchesStatus && matchesPriority;
            });
            
            return filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function renderLeads() {
            const tbody = document.getElementById('leadsTable');
            const noLeads = document.getElementById('noLeads');
            const filteredLeads = getFilteredLeads();
            
            tbody.innerHTML = '';
            
            if (filteredLeads.length === 0) {
                tbody.parentElement.style.display = 'none';
                noLeads.classList.remove('hidden');
                return;
            }
            
            tbody.parentElement.style.display = 'table';
            noLeads.classList.add('hidden');
            
            filteredLeads.forEach(lead => {
                const row = tbody.insertRow();
                const canEdit = currentUser.role === 'admin' || 
                                 currentUser.role === 'manager';
                const isAssignedToUser = lead.addedByMobile === currentUser.mobile;
                const canAssign = currentUser.role === 'admin' || 
                                  (currentUser.role === 'manager' && getTeamMembers(currentUser.id).some(member => member.mobile === lead.addedByMobile));
                
                const timestamp = new Date(lead.timestamp);
                const timeString = timestamp.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                row.innerHTML = `
                    <td>
                        <div class="customer-info">
                            <div class="customer-avatar">üë§</div>
                            <div class="customer-details">
                                <div class="customer-name">${lead.customerName}</div>
                                <div class="customer-contact">üìû ${lead.phone}</div>
                                <div class="customer-contact">üè¢ ${lead.companyName || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="loan-info">
                            <div class="loan-type">${lead.loanType || 'N/A'} - ${lead.bankName || 'N/A'}</div>
                            <div class="loan-amount">üí∞ ‚Çπ${lead.loanAmount ? lead.loanAmount.toLocaleString() : 'N/A'}</div>
                            <div class="loan-details">Salary: ‚Çπ${lead.netSalary ? lead.netSalary.toLocaleString() : 'N/A'}</div>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateStatus(${lead.id}, this.value)" class="badge badge-${lead.status.toLowerCase().replace(/\s+/g, '')}" style="border: none; font-size: 11px;" ${!canEdit ? 'disabled' : ''}>
                            <option value="Call back" ${lead.status === 'Call back' ? 'selected' : ''}>Call back</option>
                            <option value="Close" ${lead.status === 'Close' ? 'selected' : ''}>Close</option>
                            <option value="Docs pending" ${lead.status === 'Docs pending' ? 'selected' : ''}>Docs pending</option>
                            <option value="Not interested" ${lead.status === 'Not interested' ? 'selected' : ''}>Not interested</option>
                            <option value="Already applied" ${lead.status === 'Already applied' ? 'selected' : ''}>Already applied</option>
                        </select>
                    </td>
                    <td>
                        <span class="badge priority-${lead.priority.toLowerCase()}">${lead.priority}</span>
                    </td>
                    <td>
                        <div class="added-by">
                            <div class="added-name">${lead.addedBy}</div>
                            <div class="added-date">TL: ${lead.teamLeader || 'N/A'}</div>
                        </div>
                    </td>
                    <td>
                        <div style="color: #6c757d; font-size: 12px;">
                            ${timeString}
                        </div>
                    </td>
                    <td>
                        <div class="actions">
                            <a href="tel:${lead.phone}" class="btn-call">üìû Call</a>
                            <button onclick="viewLead(${lead.id})" class="action-btn" title="View">üëÅÔ∏è</button>
                            ${(currentUser.role === 'admin' || isAssignedToUser) ? `<button onclick="deleteLead(${lead.id})" class="action-btn danger" title="Delete">üóëÔ∏è</button>` : ''}
                            ${(currentUser.role === 'admin' || canAssign) ? `<button onclick="showAssignLeadModal(${lead.id})" class="action-btn" title="Assign Lead">‚û°Ô∏è</button>` : ''}
                        </div>
                    </td>
                `;
            });
        }

        function filterLeads() {
            renderLeads();
            updateStats();
        }

        function updateStatus(leadId, newStatus) {
            const leadIndex = leads.findIndex(l => l.id === leadId);
            if (leadIndex !== -1) {
                leads[leadIndex].status = newStatus;
                saveData();
                updateStats();
                renderLeads();
            }
        }

        function deleteLead(leadId) {
            const lead = leads.find(l => l.id === leadId);
            const canDelete = currentUser.role === 'admin' || 
                                 lead.addedByMobile === currentUser.mobile;
            
            if (!canDelete) {
                alert('You can only delete leads from your team');
                return;
            }
            
            if (confirm('Are you sure you want to delete this lead?')) {
                leads = leads.filter(l => l.id !== leadId);
                saveData();
                updateStats();
                renderLeads();
            }
        }

        function exportToCSV() {
            if (currentUser.role !== 'admin') {
                alert('Access Denied: Only administrators can export data.');
                return;
            }
        
            const headers = ["ID", "Customer Name", "Phone", "Net Salary", "Company Name", "Loan Amount", "Bank Name", "Loan Type", "Status", "Priority", "Added By", "Added By Mobile", "Team Leader", "Timestamp", "Notes"];
            let csv = headers.map(header => `"${header}"`).join(",") + "\n";
        
            leads.forEach(lead => {
                const row = [
                    lead.id,
                    `"${lead.customerName.replace(/"/g, '""')}"`,
                    `"${lead.phone.replace(/"/g, '""')}"`,
                    lead.netSalary,
                    `"${lead.companyName.replace(/"/g, '""')}"`,
                    lead.loanAmount,
                    `"${lead.bankName.replace(/"/g, '""')}"`,
                    `"${lead.loanType.replace(/"/g, '""')}"`,
                    `"${lead.status.replace(/"/g, '""')}"`,
                    `"${lead.priority.replace(/"/g, '""')}"`,
                    `"${lead.addedBy.replace(/"/g, '""')}"`,
                    `"${lead.addedByMobile.replace(/"/g, '""')}"`,
                    `"${lead.teamLeader.replace(/"/g, '""')}"`,
                    `"${(lead.notes || '').replace(/"/g, '""')}"`
                ];
                csv += row.join(",") + "\n";
            });
        
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Credpi_Leads_Export_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            showAutoSaveIndicator();
        }

        // MODAL FUNCTIONS
        function showAddModal() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('netSalary').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('bankName').value = '';
            document.getElementById('loanType').value = '';
            document.getElementById('leadPriority').value = 'Medium';
            document.getElementById('leadNotes').value = '';
            document.getElementById('customBankName').value = '';
            document.getElementById('customBankInput').classList.add('hidden');
            
            populateCustomOptions();
            document.getElementById('addModal').classList.add('show');
        }

        function hideAddModal() {
            document.getElementById('addModal').classList.remove('show');
        }

        function addLead() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const netSalary = document.getElementById('netSalary').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const loanAmount = document.getElementById('loanAmount').value.trim();
            
            if (!customerName || !customerPhone || !netSalary || !companyName || !loanAmount) {
                alert('Please fill all required fields: Customer Name, Mobile Number, Net Salary, Company Name, and Obligation Amount');
                return;
            }
            
            // Get selected or custom bank
            let bankName = document.getElementById('bankName').value;
            if (bankName === 'Other Bank') {
                const customBankName = document.getElementById('customBankName').value.trim();
                if (customBankName) {
                    bankName = customBankName;
                } else {
                    alert('Please enter the bank name');
                    return;
                }
            }
            
            // Get selected loan type
            let loanType = document.getElementById('loanType').value;
            
            // Get team leader name
            let teamLeader = 'N/A';
            if (currentUser.role === 'caller' && currentUser.managerId) {
                const manager = users.find(u => u.id === currentUser.managerId);
                teamLeader = manager ? manager.name : 'N/A';
            } else if (currentUser.role === 'manager') {
                teamLeader = currentUser.name;
            }
            
            const newLead = {
                id: generateId(),
                customerName: customerName,
                phone: formatMobile(customerPhone),
                netSalary: parseInt(netSalary) || 0,
                companyName: companyName,
                loanAmount: parseInt(loanAmount),
                bankName: bankName,
                loanType: loanType,
                status: 'Call back',
                priority: document.getElementById('leadPriority').value,
                addedBy: currentUser.name,
                addedByMobile: currentUser.mobile,
                teamLeader: teamLeader,
                timestamp: formatDateTime(new Date()),
                notes: document.getElementById('leadNotes').value.trim()
            };
            
            leads.unshift(newLead);
            saveData();
            updateStats();
            renderLeads();
            hideAddModal();
        }

        function viewLead(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            
            const detailsHtml = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <a href="tel:${lead.phone}" class="btn btn-primary" style="text-decoration: none; display: inline-block; margin: 0 auto;">üìû Call ${lead.customerName}</a>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div><strong>Customer Name:</strong><br>${lead.customerName}</div>
                    <div><strong>Phone:</strong><br><a href="tel:${lead.phone}" style="color: #17a2b8; text-decoration: none;">${lead.phone}</a></div>
                    <div><strong>Company Name:</strong><br>${lead.companyName || 'Not provided'}</div>
                    <div><strong>Net Salary:</strong><br>‚Çπ${lead.netSalary ? lead.netSalary.toLocaleString() : 'Not provided'}</div>
                    <div><strong>Obligation Amount:</strong><br>‚Çπ${lead.loanAmount ? lead.loanAmount.toLocaleString() : 'Not provided'}</div>
                    <div><strong>Bank Name:</strong><br>${lead.bankName || 'Not provided'}</div>
                    <div><strong>Loan Type:</strong><br>${lead.loanType || 'Not provided'}</div>
                    <div><strong>Status:</strong><br><span class="badge badge-${lead.status.toLowerCase()}">${lead.status}</span></div>
                    <div><strong>Priority:</strong><br><span class="badge priority-${lead.priority.toLowerCase()}">${lead.priority}</span></div>
                    <div><strong>Added By:</strong><br>${lead.addedBy}</div>
                    <div><strong>Team Leader:</strong><br>${lead.teamLeader || 'N/A'}</div>
                    <div><strong>Timestamp:</strong><br>${new Date(lead.timestamp).toLocaleString()}</div>
                </div>
                ${lead.notes ? `<div><strong>Notes:</strong><br><div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 12px; border-left: 4px solid #667eea;">${lead.notes}</div></div>` : ''}
            `;
            
            document.getElementById('leadDetails').innerHTML = detailsHtml;
            document.getElementById('viewModal').classList.add('show');
        }

        function hideViewModal() {
            document.getElementById('viewModal').classList.remove('show');
        }

        function showAssignLeadModal(leadId) {
            leadIdForAssignment = leadId;
            const assignToSelect = document.getElementById('assignToUser');
            assignToSelect.innerHTML = '';
            document.getElementById('assignCallerSearch').value = '';

            let callers = [];
            if (currentUser.role === 'admin') {
                callers = users.filter(u => u.role === 'caller');
            } else if (currentUser.role === 'manager') {
                callers = getTeamMembers(currentUser.id);
            }

            if (callers.length > 0) {
                callers.forEach(caller => {
                    const option = document.createElement('option');
                    option.value = caller.id;
                    option.textContent = `${caller.name} (${caller.mobile})`;
                    assignToSelect.appendChild(option);
                });
            } else {
                assignToSelect.innerHTML = '<option value="">No callers available</option>';
            }

            document.getElementById('assignLeadModal').classList.add('show');
        }
        
        function hideAssignLeadModal() {
            document.getElementById('assignLeadModal').classList.remove('show');
            leadIdForAssignment = null;
        }

        function filterAssignCallers() {
            const searchTerm = document.getElementById('assignCallerSearch').value.toLowerCase();
            const assignToSelect = document.getElementById('assignToUser');
            assignToSelect.innerHTML = '';

            let allCallers = [];
            if (currentUser.role === 'admin') {
                allCallers = users.filter(u => u.role === 'caller');
            } else if (currentUser.role === 'manager') {
                allCallers = getTeamMembers(currentUser.id);
            }

            const filteredCallers = allCallers.filter(caller => 
                caller.name.toLowerCase().includes(searchTerm) ||
                caller.mobile.includes(searchTerm)
            );

            if (filteredCallers.length > 0) {
                filteredCallers.forEach(caller => {
                    const option = document.createElement('option');
                    option.value = caller.id;
                    option.textContent = `${caller.name} (${caller.mobile})`;
                    assignToSelect.appendChild(option);
                });
            } else {
                assignToSelect.innerHTML = '<option value="">No matching callers</option>';
            }
        }

        function performLeadAssignment() {
            const lead = leads.find(l => l.id === leadIdForAssignment);
            const selectedCallerId = document.getElementById('assignToUser').value;
            const newCaller = users.find(u => u.id == selectedCallerId);

            if (!lead || !newCaller) {
                alert('Invalid assignment selection.');
                return;
            }

            const newTeamLeader = newCaller.managerId ? getManagerName(newCaller.managerId) : 'N/A';

            if (confirm(`Are you sure you want to assign this lead to ${newCaller.name}?`)) {
                lead.addedBy = newCaller.name;
                lead.addedByMobile = newCaller.mobile;
                lead.teamLeader = newTeamLeader;

                saveData();
                updateStats();
                renderLeads();
                hideAssignLeadModal();
            }
        }
        
        function showTransferLeadsModal(sourceUserId) {
            const sourceUser = users.find(u => u.id === sourceUserId);
            if (!sourceUser) return;
        
            sourceUserIdForTransfer = sourceUserId;
        
            document.getElementById('sourceUserPlaceholder').textContent = sourceUser.name;
            const transferToSelect = document.getElementById('transferToUser');
            transferToSelect.innerHTML = ''; 
        
            let teamMembers = [];
            if (currentUser.role === 'admin') {
                teamMembers = users.filter(u => u.role === 'caller' && u.id !== sourceUserId);
            } else if (currentUser.role === 'manager') {
                teamMembers = getTeamMembers(currentUser.id).filter(member => member.id !== sourceUserId);
            }

            if (teamMembers.length === 0) {
                transferToSelect.innerHTML = '<option value="">No other team members to transfer to</option>';
                document.querySelector('#transferModal .btn-primary').disabled = true;
            } else {
                document.querySelector('#transferModal .btn-primary').disabled = false;
                teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.name} (${member.mobile})`;
                    transferToSelect.appendChild(option);
                });
            }
        
            document.getElementById('transferModal').classList.add('show');
        }
        
        function hideTransferLeadsModal() {
            document.getElementById('transferModal').classList.remove('show');
            sourceUserIdForTransfer = null;
        }
        
        function performLeadTransfer() {
            const sourceUser = users.find(u => u.id === sourceUserIdForTransfer);
            const destinationUserId = document.getElementById('transferToUser').value;
            const destinationUser = users.find(u => u.id == destinationUserId);
        
            if (!sourceUser || !destinationUser) {
                alert('Invalid transfer selection.');
                return;
            }
        
            if (confirm(`Are you sure you want to transfer all leads from ${sourceUser.name} to ${destinationUser.name}?`)) {
                leads.forEach(lead => {
                    if (lead.addedByMobile === sourceUser.mobile) {
                        lead.addedBy = destinationUser.name;
                        lead.addedByMobile = destinationUser.mobile;
                        if (destinationUser.role === 'caller' && destinationUser.managerId) {
                            const newManager = users.find(u => u.id === destinationUser.managerId);
                            lead.teamLeader = newManager ? newManager.name : 'N/A';
                        } else if (destinationUser.role === 'manager') {
                            lead.teamLeader = destinationUser.name;
                        }
                    }
                });
        
                saveData();
                updateStats();
                renderLeads();
                renderTeamPerformance(); 
        
                alert(`Successfully transferred all leads from ${sourceUser.name} to ${destinationUser.name}.`);
                hideTransferLeadsModal();
            }
        }

        // EVENT LISTENERS
        document.getElementById('loginName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginMobile').focus();
            }
        });

        document.getElementById('loginMobile').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        document.getElementById('adminUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('adminPassword').focus();
            }
        });

        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleAdminLogin();
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            document.getElementById('loginName').focus();
            
            // PWA detection
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript;charset=utf-8;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCJpbnN0YWxsIiwgZSA9PiB7IGUud2FpdFVudGlsKGNhY2hlcy5vcGVuKCJjcmVkcGktdjEiKS50aGVuKGNhY2hlID0+IGNhY2hlLmFkZEFsbChbIi8iXSkpKTsgc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGUgPT4geyBlLnJlc3BvbmRXaXRoKGNhY2hlcy5tYXRjaChlLnJlcXVlc3QpLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UgfHwgZmV0Y2goZS5yZXF1ZXN0KSkpOyB9KTs=')
                    .catch(() => {});
            }
        });
    </script>
</body>
</html>
